<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>متجر جولابينو</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f2f7; margin:0; padding:0; color:#333; }
  header { background:#7d3c98; color:white; padding:20px; text-align:center; position:relative; }
  header img { height:60px; vertical-align:middle; margin-right:10px; border-radius:15px; transition: transform 0.3s; }
  header img:hover { transform: scale(1.1); }
  #storeDescription { margin-top:10px; font-size:18px; color:#f0e5f7; }
  #searchBox { margin:15px auto; display:block; width:calc(100% - 30px); padding:10px; font-size:16px; border-radius:10px; border:1px solid #ccc; }
  #categoryFilter { margin:10px auto; display:block; width:calc(100% - 30px); padding:8px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
  .products-container { display:flex; flex-wrap:wrap; justify-content:center; margin:10px; }
  .product { border:1px solid #ddd; margin:10px; padding:10px; border-radius:15px; background:white; width:220px; text-align:center; transition: transform 0.3s, box-shadow 0.3s; }
  .product:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  .product img { width:100%; border-radius:15px; }
  .price { font-weight:bold; color:#7d3c98; font-size:16px; }
  .old-price { text-decoration: line-through; color:#999; margin-left:5px; font-size:14px; }
  .btn { padding:10px 20px; background:#7d3c98; color:white; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-size:14px; transition: background 0.3s; }
  .btn:hover { background:#5e2e72; }
  .admin-panel { display:none; padding:20px; background:#e8e0eb; }
  input, select, textarea { padding:8px; margin:5px 0; width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #ccc; }
  h3 { margin-top:20px; }
  #currentProducts div { padding:5px; border-bottom:1px solid #ccc; }
  @media (max-width: 700px) { .product { width:90%; margin:10px auto; } }
</style>
</head>
<body>

<header>
  <img id="storeLogo" src="https://via.placeholder.com/60" alt="شعار المتجر">
  <h1 style="display:inline;">متجر جولابينو</h1>
  <div id="storeDescription">أفضل جولاب هندي في مكة!</div>
  <button class="btn" onclick="toggleAdmin()" style="position:absolute; top:20px; right:20px;">لوحة التحكم</button>
</header>

<input type="text" id="searchBox" placeholder="ابحث عن المنتج أو الفئة..." oninput="filterProducts()">
<select id="categoryFilter" onchange="filterProducts()">
  <option value="all">كل الفئات</option>
</select>

<div class="products-container" id="products"></div>

<div class="admin-panel" id="adminPanel">
  <h2>لوحة التحكم</h2>
  
  <div id="loginForm">
    <input type="email" id="email" placeholder="البريد الإلكتروني">
    <input type="password" id="password" placeholder="كلمة المرور">
    <button class="btn" onclick="login()">تسجيل الدخول</button>
  </div>
  
  <div id="controlPanel" style="display:none;">
    <button class="btn" onclick="logout()">تسجيل خروج</button>
    
    <h3>معلومات المتجر</h3>
    <input type="text" id="storeDescriptionInput" placeholder="وصف المتجر">
    <input type="text" id="storeLogoInput" placeholder="رابط شعار المتجر">
    <button class="btn" onclick="updateStoreInfo()">تحديث المتجر</button>
    
    <h3>إدارة الفئات</h3>
    <input type="text" id="categoryName" placeholder="اسم الفئة الجديدة">
    <button class="btn" onclick="addCategory()">إضافة فئة</button>
    <div id="categoriesList"></div>

    <h3>إضافة منتج جديد</h3>
    <input type="text" id="productName" placeholder="اسم المنتج">
    <input type="number" id="productPrice" placeholder="السعر">
    <input type="number" id="productDiscount" placeholder="الخصم (٪)">
    <input type="text" id="productImage" placeholder="رابط صورة المنتج">
    <textarea id="productNotes" placeholder="ملاحظات المنتج"></textarea>
    <select id="productCategory"></select>
    <button class="btn" onclick="addProduct()">إضافة المنتج</button>
    
    <h3>تعديل رقم واتساب</h3>
    <input type="text" id="whatsappNumber" placeholder="رقم واتساب">
    <button class="btn" onclick="updateWhatsApp()">حفظ الرقم</button>
    
    <h3>المنتجات الحالية</h3>
    <div id="currentProducts"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCH29cehED8qz_JQWk42iIxR4QP6cpFNpE",
  authDomain: "gulabinostore.firebaseapp.com",
  projectId: "gulabinostore",
  storageBucket: "gulabinostore.firebasestorage.app",
  messagingSenderId: "220650079784",
  appId: "1:220650079784:web:40574dea6d1d7a764f171d",
  measurementId: "G-B0LZ928M4C"
};

const app = firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics(app);
const auth = firebase.auth();
const db = firebase.firestore();

let whatsappNumber = "0577564265";
let categories = [];

function toggleAdmin() {
  const panel = document.getElementById("adminPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("controlPanel").style.display = "block";
      loadCategories();
      loadProducts();
      loadStoreInfo();
    })
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut().then(() => {
    document.getElementById("controlPanel").style.display = "none";
    document.getElementById("loginForm").style.display = "block";
    alert("تم تسجيل الخروج");
  });
}

// تحميل معلومات المتجر
function loadStoreInfo() {
  db.collection("storeInfo").doc("main").get().then(doc => {
    if(doc.exists) {
      const data = doc.data();
      if(data.description) document.getElementById("storeDescription").innerText = data.description;
      if(data.logo) document.getElementById("storeLogo").src = data.logo;
      if(data.whatsapp) whatsappNumber = data.whatsapp;
    }
  });
}

function updateStoreInfo() {
  const desc = document.getElementById("storeDescriptionInput").value;
  const logo = document.getElementById("storeLogoInput").value;
  db.collection("storeInfo").doc("main").set({
    description: desc || document.getElementById("storeDescription").innerText,
    logo: logo || document.getElementById("storeLogo").src,
    whatsapp: whatsappNumber
  }).then(() => {
    if(desc) document.getElementById("storeDescription").innerText = desc;
    if(logo) document.getElementById("storeLogo").src = logo;
    alert("تم تحديث معلومات المتجر");
  });
}

// إدارة الفئات
function addCategory() {
  const name = document.getElementById("categoryName").value;
  if(!name) return alert("أدخل اسم الفئة");
  db.collection("categories").add({name}).then(() => {
    document.getElementById("categoryName").value = "";
    loadCategories();
  });
}

function loadCategories() {
  db.collection("categories").get().then(snapshot => {
    categories = [];
    const catSelect = document.getElementById("productCategory");
    const catFilter = document.getElementById("categoryFilter");
    const catList = document.getElementById("categoriesList");
    catSelect.innerHTML = "";
    catFilter.innerHTML = "<option value='all'>كل الفئات</option>";
    catList.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      categories.push({id: doc.id, name: data.name});
      const option1 = document.createElement("option");
      option1.value = doc.id;
      option1.textContent = data.name;
      catSelect.appendChild(option1);
      const option2 = document.createElement("option");
      option2.value = doc.id;
      option2.textContent = data.name;
      catFilter.appendChild(option2);
      const div = document.createElement("div");
      div.textContent = data.name;
      catList.appendChild(div);
    });
  });
}

// المنتجات
function addProduct() {
  const name = document.getElementById("productName").value;
  const price = parseFloat(document.getElementById("productPrice").value);
  const discount = parseFloat(document.getElementById("productDiscount").value) || 0;
  const image = document.getElementById("productImage").value;
  const notes = document.getElementById("productNotes").value;
  const categoryId = document.getElementById("productCategory").value;
  if(!name || !price || !image || !categoryId) return alert("أكمل جميع الحقول");
  db.collection("products").add({name, price, discount, image, notes, categoryId, created: new Date()})
    .then(() => {
      alert("تم إضافة المنتج بنجاح");
      document.getElementById("productName").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productDiscount").value = "";
      document.getElementById("productImage").value = "";
      document.getElementById("productNotes").value = "";
      loadProducts();
    });
}

function loadProducts() {
  db.collection("products").orderBy("created", "desc").get().then(snapshot => {
    const productsDiv = document.getElementById("products");
    const currentDiv = document.getElementById("currentProducts");
    productsDiv.innerHTML = "";
    currentDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const catName = categories.find(c => c.id === data.categoryId)?.name || "";

      // لوحة التحكم
      const div = document.createElement("div");
      div.innerHTML = `${data.name} (${catName}) - ${data.price} ريال ${data.discount ? `<span class="old-price">${data.price} ريال</span>` : ""} 
        <button onclick="deleteProduct('${doc.id}')">حذف</button>`;
      if(data.notes) div.innerHTML += `<br>ملاحظات: ${data.notes}`;
      currentDiv.appendChild(div);

      // عرض للزوار
      const pDiv = document.createElement("div");
      pDiv.className = "product";
      const finalPrice = data.discount ? (data.price * (1 - data.discount/100)).toFixed(2) : data.price;
      pDiv.setAttribute("data-category", data.categoryId);
      pDiv.innerHTML = `<img src="${data.image}" alt="${data.name}">
        <h4>${data.name}</h4>
        <p class="price">${finalPrice} ريال ${data.discount ? `<span class="old-price">${data.price} ريال</span>` : ""}</p>
        ${data.notes ? `<p>${data.notes}</p>` : ""}
        <p><small>${catName}</small></p>
        <button class="btn" onclick="order('${data.name}', '${finalPrice}')">اطلب الآن</button>`;
      productsDiv.appendChild(pDiv);
    });
  });
}

function deleteProduct(id) {
  if(confirm("هل أنت متأكد من حذف هذا المنتج؟")) {
    db.collection("products").doc(id).delete().then(() => {
      alert("تم حذف المنتج");
      loadProducts();
    });
  }
}

function updateWhatsApp() {
  const number = document.getElementById("whatsappNumber").value;
  if(!number) return alert("أدخل الرقم");
  whatsappNumber = number;
  db.collection("storeInfo").doc("main").update({whatsapp: whatsappNumber});
  alert("تم تحديث رقم واتساب وحفظه في Firebase");
}

function order(name, price) {
  const message = `أريد طلب المنتج: ${name} بسعر ${price} ريال`;
  window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, "_blank");
  db.collection("orders").add({name, price, time: new Date()});
}

// البحث والفلاتر
function filterProducts() {
  const query = document.getElementById("searchBox").value.toLowerCase();
  const category = document.getElementById("categoryFilter").value;
  document.querySelectorAll(".product").forEach(p => {
    const text = p.innerText.toLowerCase();
    const matchesCategory = category === "all" || p.getAttribute("data-category") === category;
    p.style.display = text.includes(query) && matchesCategory ? "inline-block" : "none";
  });
}

window.onload = () => {
  loadCategories();
  loadProducts();
  loadStoreInfo();
};
</script>

</body>
</html>